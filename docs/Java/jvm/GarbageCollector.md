---
title: 垃圾回收器
date: 2021-01-10
categories:
 - JVM
tags:
 - JVM
---

## 垃圾回收的相关概念

### 垃圾回收的并行、串行与并发

并行（Parallel）：指多条垃圾收集线程并行工作，但此时用户线程仍处于等待状态

串行（Serial）：相较于并行的概念，单线程执行，如果内存不够，则程序暂停，启动JVM垃圾回收器进行垃圾回收。回收完，再启动程序的线程。

并发（Concurrent）：指用户线程与垃圾收集线程同时执行（但不一定是并行的，可能会交替执行），垃圾回收线程在执行时不会停顿用户程序的运行。用户程序在继续运行，而垃圾收集程序线程运行与另一个CPU上。

### 安全点和安全区域

**安全点**：程序执行时并非在所有地方都能停顿下来开始GC，只有在特定的位置才能停顿下来开始GC，这些位置称为安全点（SafePoint）。

Safe Point的选择很重要，如果太少可能导致GC等待时间太长，如果太频繁可能导致运行时的性能问题。大部分指令的执行时间都非常短暂，通常会根据“是否具有让程序长时间执行的特征”为标准。比如：选择一些执行时间较长的指令作为Safe Point，如方法调用、循环跳转和异常跳转等。

> 如果在GC发生时，检查所有线程都跑到了最近的安全点停顿下来呢？
>
> - 抢先式中断（目前没有虚拟机采用）：首先中断所有线程。如果还有线程不在安全点，就恢复线程，让线程跑到安全点。
> - 主动式中断：设置一个中断标志，各个线程运行到Safe Point的时候主动轮询这个表示，如果中断标志为true，则将自己进行中断挂起。

Safe Point机制保证了程序执行时，在不太长的时间内就会遇到可进入GC的Safe Point。但是，程序“不执行”的时候，例如线程处于sleep状态或阻塞状态，这个时候线程无法响应JVM的中断请求，无法达到安全点去中断挂起，JVM也不太可能等待线程被唤醒。对于这种情况，就需要**安全区域**（Safe Region）来解决。

安全区域是指在一段代码片段中，对象的引用关系不会发生变化，在这个区域中的任何位置开始GC都是安全。我们也可以把Safe Region看做是被扩展了的Safe Point。

> 实际执行：
>
> 1. 当线程运行到Safe Region的代码时，首先标识已经进入了Safe Region，如果这段时间内发生GC，JVM会忽略标识为Safe Region状态的线程。
> 2. 当线程即将离开Safe Region时，会检查JVM是否已经完成GC，如果完成了，则继续运行，否则线程必须等待直到收到可以安全离开Safe Region的信号为止。